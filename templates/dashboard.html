<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Phishing Results Dashboard (Anonymized)</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f6f8fb;
      color: #111;
      overflow-x: hidden;
    }

    h1 { color: #0b4da2 }

    .row {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      flex-wrap: nowrap;
    }

    .card {
      background: #fff;
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      flex: 1;
      min-height: 420px;         /* bigger */
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 340px;             /* larger canvas */
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      background: #fff;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      background: #eef3f8;
      color: #333;
      font-weight: 600;
    }

    .btn {
      display: inline-block;
      padding: 9px 15px;
      background: #0b4da2;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      margin-right: 8px;
    }

    .btn-secondary {
      background: #6b7280;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Phishing Results Dashboard (Anonymized)</h1>

<div class="controls">
  <a class="btn" href="/export_anonymized.csv">Export anonymized CSV</a>
  <a class="btn btn-secondary" href="/">Refresh</a>
  <span style="margin-left:12px">Total shown: {{ total }}</span>
</div>

<!-- CHARTS SECTION -->
<div class="row">
  <div class="card" style="flex:2">
    <h3>Submissions over last 30 days</h3>
    <div class="chart-container">
      <canvas id="chartByDay"></canvas>
    </div>
  </div>

  <div class="card" style="flex:1">
    <h3>Share by Campaign</h3>
    <div class="chart-container">
      <canvas id="chartByCampaign"></canvas>
    </div>
  </div>
</div>

<!-- TABLE -->
<div class="card" style="margin-top:20px; min-height:auto;">
  <h3>Details (anonymized)</h3>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Email (masked)</th>
        <th>Email hash</th>
        <th>Password (masked)</th>
        <th>Password hash</th>
        <th>Timestamp</th>
        <th>Campaign</th>
      </tr>
    </thead>

    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.email_masked }}</td>
        <td>{{ r.email_hash }}</td>
        <td>{{ r.password_masked }}</td>
        <td>{{ r.pwd_hash }}</td>
        <td>{{ r.ts }}</td>
        <td>{{ r.campaign }}</td>
      </tr>
      {% endfor %}

      {% if rows|length == 0 %}
      <tr><td colspan="7" style="text-align:center;padding:20px">No data yet.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
async function fetchData() {
  const res = await fetch('/data.json');
  return res.json();
}

function randomColor(i) {
  const palette = [
    '#0b4da2','#1d4ed8','#10b981','#f97316',
    '#8b5cf6','#ef4444','#f59e0b','#0ea5e9'
  ];
  return palette[i % palette.length];
}

(async function initCharts(){
  const data = await fetchData();

  // BAR CHART
  new Chart(document.getElementById('chartByDay'), {
    type: 'bar',
    data: {
      labels: data.by_day.labels,
      datasets: [{
        label: 'Submissions',
        data: data.by_day.counts,
        backgroundColor: data.by_day.labels.map((_,i)=>randomColor(i)),
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } }
    }
  });

  // PIE CHART
  new Chart(document.getElementById('chartByCampaign'), {
    type: 'pie',
    data: {
      labels: data.by_campaign.labels,
      datasets: [{
        data: data.by_campaign.counts,
        backgroundColor: data.by_campaign.labels.map((_,i)=>randomColor(i)),
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

})();
</script>

</body>
</html>
